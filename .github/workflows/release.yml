name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install OpenSSL
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install openssl
          else
            choco install openssl.light -y
          fi
        shell: bash

      - name: Show OpenSSL version
        run: |
          if [[ "$RUNNER_OS" == "Linux" || "$RUNNER_OS" == "macOS" ]]; then
            openssl version
          else
            "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" version
          fi
        shell: bash

      - name: Configure CMake
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DOPENSSL_ROOT_DIR=$(brew --prefix openssl)
          else
            cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          fi
        shell: bash

      - name: Build project
        run: cmake --build build --config Release
        shell: bash

      - name: Prepare binary for upload
        run: |
          mkdir artifacts
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            cp build/crypto_tool artifacts/crypto_tool-linux
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            cp build/crypto_tool artifacts/crypto_tool-macos
          else
            if [ -f build/Release/crypto_tool.exe ]; then
              cp build/Release/crypto_tool.exe artifacts/crypto_tool-windows.exe
            elif [ -f build/Debug/crypto_tool.exe ]; then
              cp build/Debug/crypto_tool.exe artifacts/crypto_tool-windows.exe
            else
              echo "‚ùå Could not find compiled binary"
              ls -R build
              exit 1
            fi
          fi
        shell: bash

      - name: List built files
        run: ls -R artifacts
        shell: bash

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}
          path: artifacts/

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_binaries/

      - name: List release binaries
        run: ls -R release_binaries
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body: |
            ‚úÖ Automatic build for ${{ github.ref_name }}

            Includes binaries for:
            - üêß Linux
            - üçé macOS
            - ü™ü Windows

            Built automatically via GitHub Actions.
          files: release_binaries/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
